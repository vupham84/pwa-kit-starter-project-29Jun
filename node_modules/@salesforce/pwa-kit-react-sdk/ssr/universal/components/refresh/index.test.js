"use strict";

var _reactQuery = require("@tanstack/react-query");
var _react = require("@testing-library/react");
var _react2 = _interopRequireDefault(require("react"));
var _reactRouterDom = require("react-router-dom");
var _index = _interopRequireDefault(require("./index"));
function _interopRequireDefault(e) { return e && e.__esModule ? e : { default: e }; }
function asyncGeneratorStep(n, t, e, r, o, a, c) { try { var i = n[a](c), u = i.value; } catch (n) { return void e(n); } i.done ? t(u) : Promise.resolve(u).then(r, o); }
function _asyncToGenerator(n) { return function () { var t = this, e = arguments; return new Promise(function (r, o) { var a = n.apply(t, e); function _next(n) { asyncGeneratorStep(a, r, o, _next, _throw, "next", n); } function _throw(n) { asyncGeneratorStep(a, r, o, _next, _throw, "throw", n); } _next(void 0); }); }; } /*
 * Copyright (c) 2023, Salesforce, Inc.
 * All rights reserved.
 * SPDX-License-Identifier: BSD-3-Clause
 * For full license text, see the LICENSE file in the repo root or https://opensource.org/licenses/BSD-3-Clause
 */
jest.useFakeTimers();
const referrerURL = 'some-url';
jest.mock('react-router-dom', () => {
  const replace = jest.fn();
  return {
    useHistory: jest.fn(() => ({
      replace
    })),
    useLocation: jest.fn(() => ({
      search: `?referrer=${referrerURL}`
    }))
  };
});
jest.mock('@tanstack/react-query', () => {
  const invalidateQueries = jest.fn();
  return {
    useQueryClient: jest.fn(() => ({
      invalidateQueries
    }))
  };
});
test('renders a loading spinner initially', () => {
  (0, _react.render)( /*#__PURE__*/_react2.default.createElement(_index.default, null));
  expect(_react.screen.getByTestId('loading-spinner')).toBeInTheDocument();
});
test('wait for react-query cache to be invalidated', /*#__PURE__*/_asyncToGenerator(function* () {
  (0, _react.render)( /*#__PURE__*/_react2.default.createElement(_index.default, null));
  yield (0, _react.waitFor)(() => {
    expect((0, _reactQuery.useQueryClient)().invalidateQueries).toHaveBeenCalled();
  });
}));
test('a project not using react-query', /*#__PURE__*/_asyncToGenerator(function* () {
  // If customer project does not use react-query, calling useQueryClient would throw an error
  _reactQuery.useQueryClient.mockImplementationOnce(() => {
    throw new Error();
  });
  (0, _react.render)( /*#__PURE__*/_react2.default.createElement(_index.default, null));
  jest.runAllTimers();
  yield (0, _react.waitFor)(() => {
    // Expect to still continue despite the project not using react-query,
    // specifically continue to navigate back to the referrer.
    expect((0, _reactRouterDom.useHistory)().replace).toHaveBeenCalledWith(referrerURL);
  });
}));
test('wait for soft navigation to the referrer', /*#__PURE__*/_asyncToGenerator(function* () {
  (0, _react.render)( /*#__PURE__*/_react2.default.createElement(_index.default, null));
  jest.runAllTimers();
  yield (0, _react.waitFor)(() => {
    expect((0, _reactRouterDom.useHistory)().replace).toHaveBeenCalledWith(referrerURL);
  });
}));
test('navigate to homepage if `referrer` search param cannot be found in the page url', /*#__PURE__*/_asyncToGenerator(function* () {
  jest.spyOn(console, 'warn');
  _reactRouterDom.useLocation.mockImplementationOnce(() => ({
    search: ''
  }));
  (0, _react.render)( /*#__PURE__*/_react2.default.createElement(_index.default, null));
  jest.runAllTimers();
  yield (0, _react.waitFor)(() => {
    expect(console.warn).toHaveBeenCalled();
    expect((0, _reactRouterDom.useHistory)().replace).toHaveBeenCalledWith('/');
  });
}));